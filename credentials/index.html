<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¸³è™Ÿç®¡ç†å·¥å…·</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Segoe UI', sans-serif;
    background: #0f0f1a;
    color: #e0e0e0;
    min-height: 100vh;
    padding: 20px;
  }

  .container {
    max-width: 1100px;
    margin: 0 auto;
  }

  h1 {
    text-align: center;
    margin-bottom: 8px;
    font-size: 1.8rem;
    background: linear-gradient(135deg, #00d2ff, #7b2ff7);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .subtitle {
    text-align: center;
    color: #888;
    margin-bottom: 30px;
    font-size: 0.9rem;
  }

  /* â”€â”€ Toolbar â”€â”€ */
  .toolbar {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }

  .toolbar button, .toolbar label {
    padding: 10px 18px;
    border: none;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform .15s, box-shadow .15s;
  }

  .toolbar button:hover, .toolbar label:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(0,0,0,.4);
  }

  .btn-add      { background: #2ecc71; color: #fff; }
  .btn-clear    { background: #e74c3c; color: #fff; }
  .btn-import   { background: #3498db; color: #fff; display: inline-flex; align-items: center; gap: 4px; }
  .btn-import input { display: none; }
  .btn-paste    { background: #9b59b6; color: #fff; }

  /* â”€â”€ Table â”€â”€ */
  .table-wrap {
    overflow-x: auto;
    border-radius: 12px;
    border: 1px solid #2a2a40;
    margin-bottom: 24px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 750px;
  }

  thead th {
    background: #1a1a2e;
    padding: 14px 12px;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #aaa;
    border-bottom: 2px solid #7b2ff7;
    position: sticky;
    top: 0;
  }

  tbody tr {
    transition: background .15s;
  }

  tbody tr:hover { background: #1e1e36; }

  tbody td {
    padding: 4px;
    border-bottom: 1px solid #1f1f35;
  }

  tbody td input {
    width: 100%;
    padding: 10px;
    border: none;
    border-radius: 6px;
    background: #16162b;
    color: #e0e0e0;
    font-size: 0.9rem;
    outline: none;
    transition: box-shadow .2s;
  }

  tbody td input:focus {
    box-shadow: 0 0 0 2px #7b2ff7;
  }

  .row-num {
    text-align: center;
    color: #555;
    font-size: 0.8rem;
    width: 40px;
  }

  .btn-del {
    background: transparent;
    border: none;
    color: #e74c3c;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 6px 10px;
    border-radius: 6px;
    transition: background .15s;
  }

  .btn-del:hover { background: rgba(231,76,60,.15); }

  /* â”€â”€ Export Panel â”€â”€ */
  .export-panel {
    background: #1a1a2e;
    border-radius: 12px;
    padding: 24px;
    border: 1px solid #2a2a40;
  }

  .export-panel h2 {
    font-size: 1.1rem;
    margin-bottom: 16px;
    color: #ccc;
  }

  .export-row {
    display: flex;
    gap: 14px;
    flex-wrap: wrap;
    align-items: center;
  }

  .toggle-group {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .switch {
    position: relative;
    width: 48px;
    height: 26px;
  }

  .switch input { display: none; }

  .slider {
    position: absolute;
    inset: 0;
    background: #333;
    border-radius: 26px;
    cursor: pointer;
    transition: background .3s;
  }

  .slider::before {
    content: '';
    position: absolute;
    width: 20px; height: 20px;
    left: 3px; top: 3px;
    background: #fff;
    border-radius: 50%;
    transition: transform .3s;
  }

  .switch input:checked + .slider { background: #7b2ff7; }
  .switch input:checked + .slider::before { transform: translateX(22px); }

  .pass-input {
    padding: 10px 14px;
    border: 1px solid #333;
    border-radius: 8px;
    background: #16162b;
    color: #e0e0e0;
    font-size: 0.9rem;
    width: 220px;
    outline: none;
    transition: box-shadow .2s, opacity .3s;
  }

  .pass-input:focus { box-shadow: 0 0 0 2px #7b2ff7; }
  .pass-input:disabled { opacity: .3; }

  .btn-export {
    padding: 12px 28px;
    border: none;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 700;
    cursor: pointer;
    background: linear-gradient(135deg, #7b2ff7, #00d2ff);
    color: #fff;
    transition: transform .15s, box-shadow .15s;
  }

  .btn-export:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(123,47,247,.4);
  }

  .btn-decrypt {
    padding: 12px 28px;
    border: none;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 700;
    cursor: pointer;
    background: linear-gradient(135deg, #f39c12, #e74c3c);
    color: #fff;
    transition: transform .15s, box-shadow .15s;
  }

  .btn-decrypt:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(231,76,60,.4);
  }

  /* â”€â”€ Toast â”€â”€ */
  .toast {
    position: fixed;
    bottom: 30px;
    right: 30px;
    padding: 14px 24px;
    border-radius: 10px;
    color: #fff;
    font-weight: 600;
    font-size: 0.9rem;
    opacity: 0;
    transform: translateY(20px);
    transition: all .3s;
    pointer-events: none;
    z-index: 999;
  }

  .toast.show {
    opacity: 1;
    transform: translateY(0);
  }

  .toast.success { background: #2ecc71; }
  .toast.error   { background: #e74c3c; }
  .toast.info    { background: #3498db; }

  /* â”€â”€ Modal â”€â”€ */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.6);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.active { display: flex; }

  .modal {
    background: #1a1a2e;
    border-radius: 14px;
    padding: 30px;
    width: 400px;
    max-width: 90vw;
    border: 1px solid #2a2a40;
  }

  .modal h3 { margin-bottom: 16px; color: #ccc; }

  .modal .pass-input { width: 100%; margin-bottom: 16px; }

  .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; }

  .modal-buttons button {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
  }

  .modal-cancel { background: #333; color: #ccc; }
  .modal-confirm { background: #7b2ff7; color: #fff; }

  /* â”€â”€ Preview â”€â”€ */
  .preview {
    margin-top: 20px;
    background: #16162b;
    border-radius: 10px;
    padding: 16px;
    border: 1px solid #2a2a40;
    max-height: 300px;
    overflow: auto;
    display: none;
  }

  .preview pre {
    color: #7bed9f;
    font-size: 0.82rem;
    white-space: pre-wrap;
    word-break: break-all;
  }

  .preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .preview-header span {
    color: #888;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .preview-header button {
    font-size: 0.75rem;
    padding: 4px 12px;
    border-radius: 6px;
    border: 1px solid #333;
    background: transparent;
    color: #aaa;
    cursor: pointer;
  }

  .count-badge {
    background: #7b2ff7;
    color: #fff;
    padding: 2px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    margin-left: 8px;
  }
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ” å¸³è™Ÿç®¡ç†å·¥å…·</h1>
  <p class="subtitle">ç®¡ç†å¸³è™Ÿè³‡æ–™ï¼Œæ”¯æ´ JSON åŒ¯å‡ºèˆ‡ AES åŠ å¯†</p>

  <!-- Toolbar -->
  <div class="toolbar">
    <button class="btn-add" onclick="addRow()">ï¼‹ æ–°å¢åˆ—</button>
    <label class="btn-import">
      ğŸ“‚ åŒ¯å…¥æª”æ¡ˆ
      <input type="file" accept=".json,.csv,.enc" onchange="importFile(event)">
    </label>
    <button class="btn-paste" onclick="pasteFromClipboard()">ğŸ“‹ è²¼ä¸Š</button>
    <button class="btn-clear" onclick="clearAll()">ğŸ—‘ æ¸…ç©ºå…¨éƒ¨</button>
  </div>

  <!-- Table -->
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Username</th>
          <th>Password</th>
          <th>AuthToken</th>
          <th>CsrfToken</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- Export Panel -->
  <div class="export-panel">
    <h2>ğŸ“¤ è¼¸å‡ºè¨­å®š <span class="count-badge" id="countBadge">0 ç­†</span></h2>
    <div class="export-row">
      <div class="toggle-group">
        <label class="switch">
          <input type="checkbox" id="encryptToggle" onchange="toggleEncrypt()">
          <span class="slider"></span>
        </label>
        <span>AES åŠ å¯†</span>
      </div>
      <input type="password" class="pass-input" id="encryptPass"
             placeholder="è¼¸å…¥åŠ å¯†å¯†ç¢¼â€¦" disabled>
      <button class="btn-export" onclick="exportFile()">â¬‡ è¼¸å‡ºæª”æ¡ˆ</button>
      <button class="btn-decrypt" onclick="openDecryptModal()">ğŸ”“ è§£å¯†æª”æ¡ˆ</button>
    </div>

    <!-- Preview -->
    <div class="preview" id="preview">
      <div class="preview-header">
        <span>é è¦½</span>
        <button onclick="document.getElementById('preview').style.display='none'">é—œé–‰</button>
      </div>
      <pre id="previewContent"></pre>
    </div>
  </div>
</div>

<!-- Decrypt Modal -->
<div class="modal-overlay" id="decryptModal">
  <div class="modal">
    <h3>ğŸ”“ è§£å¯† .enc æª”æ¡ˆ</h3>
    <input type="password" class="pass-input" id="decryptPass" placeholder="è¼¸å…¥è§£å¯†å¯†ç¢¼â€¦">
    <label class="btn-import" style="margin-bottom:16px;display:inline-flex">
      é¸æ“‡ .enc æª”æ¡ˆ
      <input type="file" accept=".enc" id="decryptFileInput">
    </label>
    <span id="decryptFileName" style="color:#888;font-size:0.85rem;"></span>
    <div class="modal-buttons" style="margin-top:16px">
      <button class="modal-cancel" onclick="closeDecryptModal()">å–æ¶ˆ</button>
      <button class="modal-confirm" onclick="decryptFile()">è§£å¯†ä¸¦è¼‰å…¥</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// â”€â”€ State â”€â”€
let rows = [];
let rowIdCounter = 0;

// Init with 3 empty rows
(function init() {
  addRow(); addRow(); addRow();
})();

// â”€â”€ Row Management â”€â”€
function addRow(data = {}) {
  const id = rowIdCounter++;
  rows.push({ id, ...data });
  renderTable();
  updateCount();
}

function removeRow(id) {
  rows = rows.filter(r => r.id !== id);
  renderTable();
  updateCount();
}

function clearAll() {
  if (rows.length && !confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿ')) return;
  rows = [];
  rowIdCounter = 0;
  addRow(); addRow(); addRow();
  toast('å·²æ¸…ç©º', 'info');
}

function updateCount() {
  const filled = rows.filter(r => r.username || r.password || r.authToken || r.csrfToken).length;
  document.getElementById('countBadge').textContent = filled + ' ç­†';
}

// â”€â”€ Render â”€â”€
function renderTable() {
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';
  rows.forEach((row, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="row-num">${idx + 1}</td>
      <td><input type="text" value="${esc(row.username||'')}" data-id="${row.id}" data-field="username" oninput="updateField(this)"></td>
      <td><input type="text" value="${esc(row.password||'')}" data-id="${row.id}" data-field="password" oninput="updateField(this)"></td>
      <td><input type="text" value="${esc(row.authToken||'')}" data-id="${row.id}" data-field="authToken" oninput="updateField(this)"></td>
      <td><input type="text" value="${esc(row.csrfToken||'')}" data-id="${row.id}" data-field="csrfToken" oninput="updateField(this)"></td>
      <td><button class="btn-del" onclick="removeRow(${row.id})">âœ•</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function updateField(el) {
  const id = parseInt(el.dataset.id);
  const field = el.dataset.field;
  const row = rows.find(r => r.id === id);
  if (row) row[field] = el.value;
  updateCount();
}

function esc(s) {
  return s.replace(/"/g, '&quot;').replace(/</g, '&lt;');
}

// â”€â”€ Export â”€â”€
function toggleEncrypt() {
  const on = document.getElementById('encryptToggle').checked;
  document.getElementById('encryptPass').disabled = !on;
  if (on) document.getElementById('encryptPass').focus();
}

function buildJSON() {
  const accounts = rows.map(r => ({
    username:  r.username  || '',
    password:  r.password  || '',
    authToken: r.authToken || '',
    csrfToken: r.csrfToken || ''
  })).filter(a => a.username || a.password || a.authToken || a.csrfToken);

  if (!accounts.length) {
    toast('æ²’æœ‰å¯è¼¸å‡ºçš„è³‡æ–™', 'error');
    return null;
  }
  return { accounts };
}

function exportFile() {
  const data = buildJSON();
  if (!data) return;

  const encrypt = document.getElementById('encryptToggle').checked;
  const password = document.getElementById('encryptPass').value;

  if (encrypt && !password) {
    toast('è«‹è¼¸å…¥åŠ å¯†å¯†ç¢¼', 'error');
    return;
  }

  let content, filename, mime;

  if (encrypt) {
    const jsonStr = JSON.stringify(data);
    const encrypted = CryptoJS.AES.encrypt(jsonStr, password).toString();
    content = encrypted;
    filename = 'accounts.enc';
    mime = 'application/octet-stream';
    toast('å·²åŠ å¯†è¼¸å‡º âœ”', 'success');
  } else {
    content = JSON.stringify(data, null, 2);
    filename = 'accounts.json';
    mime = 'application/json';
    toast('å·²è¼¸å‡º JSON âœ”', 'success');
  }

  // Show preview
  const prev = document.getElementById('preview');
  const prevContent = document.getElementById('previewContent');
  prev.style.display = 'block';
  prevContent.textContent = encrypt ? content.substring(0, 500) + 'â€¦' : content;

  // Download
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

// â”€â”€ Import â”€â”€
function importFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    const text = ev.target.result;
    try {
      if (file.name.endsWith('.csv')) {
        importCSV(text);
      } else if (file.name.endsWith('.enc')) {
        toast('è«‹ä½¿ç”¨ã€Œè§£å¯†æª”æ¡ˆã€åŠŸèƒ½åŒ¯å…¥ .enc', 'info');
      } else {
        importJSON(text);
      }
    } catch (err) {
      toast('åŒ¯å…¥å¤±æ•—: ' + err.message, 'error');
    }
  };
  reader.readAsText(file);
  e.target.value = '';
}

function importJSON(text) {
  const data = JSON.parse(text);
  const accounts = data.accounts || data;
  if (!Array.isArray(accounts)) throw new Error('æ ¼å¼ä¸æ­£ç¢º');
  rows = [];
  rowIdCounter = 0;
  accounts.forEach(a => addRow(a));
  toast(`å·²åŒ¯å…¥ ${accounts.length} ç­†`, 'success');
}

function importCSV(text) {
  const lines = text.trim().split('\n');
  const header = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
  rows = [];
  rowIdCounter = 0;
  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
    const obj = {};
    header.forEach((h, j) => { obj[h] = cols[j] || ''; });
    addRow(obj);
  }
  toast(`å·²åŒ¯å…¥ ${lines.length - 1} ç­†`, 'success');
}

// â”€â”€ Paste â”€â”€
async function pasteFromClipboard() {
  try {
    const text = await navigator.clipboard.readText();
    // try tab-separated (from spreadsheet copy)
    const lines = text.trim().split('\n');
    if (lines.length > 0 && lines[0].includes('\t')) {
      rows = [];
      rowIdCounter = 0;
      lines.forEach(line => {
        const cols = line.split('\t');
        addRow({
          username:  cols[0] || '',
          password:  cols[1] || '',
          authToken: cols[2] || '',
          csrfToken: cols[3] || ''
        });
      });
      toast(`å·²è²¼ä¸Š ${lines.length} ç­†`, 'success');
    } else {
      // try JSON
      importJSON(text);
    }
  } catch {
    toast('ç„¡æ³•è®€å–å‰ªè²¼ç°¿', 'error');
  }
}

// â”€â”€ Decrypt Modal â”€â”€
function openDecryptModal() {
  document.getElementById('decryptModal').classList.add('active');
  document.getElementById('decryptPass').value = '';
  document.getElementById('decryptFileName').textContent = '';
}

function closeDecryptModal() {
  document.getElementById('decryptModal').classList.remove('active');
}

document.getElementById('decryptFileInput').addEventListener('change', function() {
  document.getElementById('decryptFileName').textContent = this.files[0]?.name || '';
});

function decryptFile() {
  const fileInput = document.getElementById('decryptFileInput');
  const password = document.getElementById('decryptPass').value;

  if (!fileInput.files[0]) { toast('è«‹é¸æ“‡æª”æ¡ˆ', 'error'); return; }
  if (!password) { toast('è«‹è¼¸å…¥å¯†ç¢¼', 'error'); return; }

  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      const decrypted = CryptoJS.AES.decrypt(ev.target.result, password);
      const jsonStr = decrypted.toString(CryptoJS.enc.Utf8);
      if (!jsonStr) throw new Error('å¯†ç¢¼éŒ¯èª¤æˆ–æª”æ¡ˆæå£');
      importJSON(jsonStr);
      closeDecryptModal();
      toast('è§£å¯†æˆåŠŸ âœ”', 'success');
    } catch (err) {
      toast('è§£å¯†å¤±æ•—: ' + err.message, 'error');
    }
  };
  reader.readAsText(fileInput.files[0]);
}

// â”€â”€ Toast â”€â”€
function toast(msg, type = 'info') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast ' + type + ' show';
  setTimeout(() => el.classList.remove('show'), 2500);
}
</script>
</body>
</html>
